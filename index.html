<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NutriSeed – Calculadora de Deficiencias Nutricionales</title>
    <style>
      :root {
        --card-bg: rgba(255, 255, 255, 0.25);
        --border-color: rgba(255, 255, 255, 0.3);
        --accent-color: #f7bf2c;
        --text-color: #3d3d3c;
      }
      body {
        margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif;
        background: linear-gradient(135deg, #3d3d3c, #f7bf2c);
        display: flex; justify-content: center; align-items: center; min-height: 100vh; box-sizing: border-box;
      }
      .app-wrapper {
        backdrop-filter: blur(15px); background: var(--card-bg); border-radius: 2rem;
        border: 1px solid var(--border-color); box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        padding: 2rem; width: 100%; max-width: 600px; display: flex; flex-direction: column; box-sizing: border-box;
      }
      .header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 1rem; }
      h1 { margin:0; color: var(--text-color); font-size: 2rem; }
      .header .logo { width: 80px; height: auto; }
      label { display:block; margin-top:1rem; font-weight:600; color: var(--text-color); }
      input, select {
        width:100%; padding:0.6rem 0.8rem; margin-top:0.4rem; border-radius:0.8rem; border:1px solid var(--border-color);
        background: rgba(255,255,255,0.4); color:#333; font-size:1rem; box-sizing: border-box;
      }
      button {
        width:100%; padding:0.8rem; margin-top:1.5rem; border-radius:1rem; border:none;
        background: linear-gradient(145deg, var(--accent-color), #3d3d3c); color:#fff; font-size:1rem; font-weight:600;
        cursor:pointer; transition: transform 0.1s ease;
      }
      button:active { transform: scale(0.98); }
      .result { margin-top:1.5rem; padding:1rem; border-radius:1rem; background: rgba(255,255,255,0.3); color:var(--text-color); display:none; line-height:1.6; }
      .fertilizer-table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:0.9rem; }
      .fertilizer-table th, .fertilizer-table td { padding:0.5rem; border:1px solid rgba(255,255,255,0.2); text-align:left; color:var(--text-color); }
      .fertilizer-table th { font-weight:bold; background: rgba(255,255,255,0.2); }
      footer { margin-top:2rem; text-align:center; color:var(--text-color); font-size:0.9rem; }
      @media (max-width:600px){ .app-wrapper{ padding:1.5rem; border-radius:1.5rem; } h1{ font-size:1.6rem; } }
    </style>
  </head>
  <body>
    <div class="app-wrapper">
      <div class="header">
        <h1>NutriSeed</h1>
        <img src="logo.png" alt="Logo PreSeeds" class="logo" />
      </div>

      <form id="nutriForm">
        <label for="crop">Cultivo</label>
        <select id="crop" required>
          <option value="" disabled selected>Selecciona un cultivo</option>
          <option value="soja">Soja</option>
          <option value="trigo">Trigo</option>
          <option value="maiz">Maíz</option>
          <option value="girasol">Girasol</option>
          <option value="mani">Maní</option>
          <option value="cebada">Cebada</option>
          <option value="lenteja">Lenteja</option>
          <option value="arveja">Arveja</option>
          <option value="picingallo">Maíz Picingallo</option>
          <option value="algodon">Algodón</option>
        </select>

        <label for="yearType">Condición del año</label>
        <select id="yearType" required>
          <option value="" disabled selected>Selecciona una condición</option>
          <option value="seco">Seco</option>
          <option value="neutro">Neutro</option>
          <option value="humedo">Húmedo</option>
        </select>

        <label for="nVal">Análisis Nitrógeno (N)</label>
        <input type="text" id="nVal" placeholder="Ingresa N (ppm, mg/kg o unidad equivalente)" required />

        <label for="pVal">Análisis Fósforo (P)</label>
        <input type="text" id="pVal" placeholder="Ingresa P (ppm, mg/kg o unidad equivalente)" required />

        <label for="kVal">Análisis Potasio (K)</label>
        <input type="text" id="kVal" placeholder="Ingresa K (ppm, mg/kg o unidad equivalente)" required />

        <label for="omVal">Materia orgánica (%)</label>
        <input type="text" id="omVal" placeholder="Ingresa % MO (materia orgánica)" />

        <label for="sVal">Azufre (S)</label>
        <input type="text" id="sVal" placeholder="Ingresa S (mg/kg)" />

        <label for="caVal">Calcio (Ca)</label>
        <input type="text" id="caVal" placeholder="Ingresa Ca (mg/kg)" />

        <label for="mgVal">Magnesio (Mg)</label>
        <input type="text" id="mgVal" placeholder="Ingresa Mg (mg/kg)" />

        <label for="nanVal">NAN</label>
        <input type="text" id="nanVal" placeholder="Ingresa NAN" />

        <label for="ecVal">Conductividad eléctrica (CE)</label>
        <input type="text" id="ecVal" placeholder="Ingresa CE (dS/m)" />

        <label for="cicVal">CIC (meq/100g)</label>
        <input type="text" id="cicVal" placeholder="Ingresa CIC (CIC)" />

        <label for="psiVal">PSI</label>
        <input type="text" id="psiVal" placeholder="Ingresa PSI" />

        <button type="submit">Calcular deficiencias</button>
      </form>

      <div id="result" class="result"></div>

      <footer>&copy; 2025 NutriSeed</footer>
    </div>

    <script>
      const baseRecommendations = {
        soja: { N: 35, P: 45, K: 100 },
        trigo: { N: 40, P: 30, K: 50 },
        maiz: { N: 60, P: 35, K: 80 },
        girasol: { N: 25, P: 40, K: 60 },
        mani: { N: 20, P: 25, K: 30 },
        cebada: { N: 35, P: 25, K: 40 },
        lenteja: { N: 20, P: 30, K: 20 },
        arveja: { N: 20, P: 35, K: 30 },
        picingallo: { N: 50, P: 30, K: 60 },
        algodon: { N: 45, P: 25, K: 70 },
      };

      const fertilizers = {
        urea: { name: 'Urea', N: 46, P: 0, K: 0, efficiency: 0.60 },
        uan:  { name: 'UAN (Urea-Ammonium Nitrate)', N: 32, P: 0, K: 0, efficiency: 0.78 },
        solmix:{ name: 'SolMIX', N: 28, P: 0, K: 0, S: 5.2, Zn: 0.5, efficiency: 0.80 },
        can:  { name: 'Nitrato de amonio calcáreo (CAN)', N: 27, P: 0, K: 0, Ca: 9, efficiency: 0.70 },
        tsp:  { name: 'Superfosfato triple (TSP)', N: 0, P: 46, K: 0, efficiency: 0.25 },
        ssp:  { name: 'Superfosfato simple (SSP)', N: 0, P: 20, K: 0, S: 14, Ca: 12, efficiency: 0.20 },
        map:  { name: 'Fosfato monoamónico (MAP)', N: 11, P: 52, K: 0, efficiency: 0.30 },
        dap:  { name: 'Fosfato diamónico (DAP)', N: 18, P: 46, K: 0, efficiency: 0.30 },
        micro:{ name: 'Microgranulados arrancadores', N: 8, P: 30, K: 0, efficiency: 0.35 },
        an:   { name: 'Nitrato de amonio (AN)', N: 34, P: 0, K: 0, efficiency: 0.70 },
        kcl:  { name: 'Cloruro de potasio (KCl)', N: 0, P: 0, K: 60, efficiency: 0.50 },
      };

      const conversionFactors = { P_TO_P2O5: 2.29, P2O5_TO_P: 0.44, K_TO_K2O: 1.20, K2O_TO_K: 0.83 };
      const defaultFertilizerFor = { N: fertilizers.uan, P: fertilizers.map, K: fertilizers.kcl };
      const yearMultipliers = { seco: 1.1, neutro: 1.0, humedo: 0.9 };

      function num(id){
        const raw = document.getElementById(id).value.trim().replace(',', '.').replace(/\s+/g,'');
        const v = parseFloat(raw);
        return Number.isFinite(v) ? v : NaN;
      }
      const fmt = v => Number.isFinite(v) ? v.toFixed(2) : '0.00';
      const deficiency = (rec, act) => Math.max(rec - act, 0);

      function adjustRecommendations(nRec, pRec, kRec, om, cic, psi) {
        let N = nRec, P = pRec, K = kRec;
        if (Number.isFinite(om))  { if (om > 4) N*=0.8; else if (om < 2) N*=1.1; }
        if (Number.isFinite(cic)) { if (cic>20) K*=0.9; else if (cic<10) K*=1.1; }
        if (Number.isFinite(psi)) { if (psi>30) P*=0.9; else if (psi<10) P*=1.1; }
        return {N,P,K};
      }

      const form = document.getElementById('nutriForm');
      const resultContainer = document.getElementById('result');

      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        try {
          const cropKey = document.getElementById('crop').value;
          const yearKey = document.getElementById('yearType').value;
          const nVal = num('nVal'), pVal = num('pVal'), kVal = num('kVal');
          const omVal = num('omVal'), sVal = num('sVal'), caVal = num('caVal'), mgVal = num('mgVal');
          const nanVal = num('nanVal'), ecVal = num('ecVal'), cicVal = num('cicVal'), psiVal = num('psiVal');

          if (!cropKey || !yearKey || !Number.isFinite(nVal) || !Number.isFinite(pVal) || !Number.isFinite(kVal)) {
            alert('Completá cultivo, condición del año y N/P/K con números válidos (coma o punto).');
            return;
          }

          const base = baseRecommendations[cropKey];
          const mult = yearMultipliers[yearKey];
          const baseRecN = base.N * mult, baseRecP = base.P * mult, baseRecK = base.K * mult;

          const adj = adjustRecommendations(baseRecN, baseRecP, baseRecK, omVal, cicVal, psiVal);
          const defN = deficiency(adj.N, nVal), defP = deficiency(adj.P, pVal), defK = deficiency(adj.K, kVal);

          function computeDose(def, key){
            if (!(def>0)) return 0;
            const fert = defaultFertilizerFor[key];
            let required = def;
            if (key==='P') required*=conversionFactors.P_TO_P2O5;
            if (key==='K') required*=conversionFactors.K_TO_K2O;
            const content = key==='N'? fert.N : key==='P'? fert.P : fert.K;
            const frac = (content||0)/100;
            if (!frac) return 0;
            const eff = fert.efficiency || 1;
            return required / (frac * eff);
          }
          const doseN = computeDose(defN,'N'), doseP = computeDose(defP,'P'), doseK = computeDose(defK,'K');

          let extraMetricsHtml = '';
          const add = (label,val,suffix='')=>{ if(Number.isFinite(val)) extraMetricsHtml += `<li>${label}: ${fmt(val)}${suffix}</li>`; };
          add('Materia orgánica (MO)', omVal, ' %'); add('CIC', cicVal);
          add('PSI', psiVal); add('Conductividad eléctrica (CE)', ecVal, ' dS/m');
          add('Azufre (S)', sVal, ' mg/kg'); add('Calcio (Ca)', caVal, ' mg/kg');
          add('Magnesio (Mg)', mgVal, ' mg/kg'); add('NAN', nanVal);

          let html = `
            <h3>Resultados para ${cropKey.charAt(0).toUpperCase() + cropKey.slice(1)}</h3>
            <p><strong>Condición del año:</strong> ${yearKey.charAt(0).toUpperCase() + yearKey.slice(1)}</p>
            <p><strong>Recomendaciones base (N-P-K):</strong> ${fmt(baseRecN)} - ${fmt(baseRecP)} - ${fmt(baseRecK)}</p>
            <p><strong>Recomendaciones ajustadas (N-P-K):</strong> ${fmt(adj.N)} - ${fmt(adj.P)} - ${fmt(adj.K)}</p>
            <p><strong>Valores medidos (N-P-K):</strong> ${fmt(nVal)} - ${fmt(pVal)} - ${fmt(kVal)}</p>
            ${extraMetricsHtml ? `<p><strong>Parámetros de suelo introducidos:</strong></p><ul>${extraMetricsHtml}</ul>` : ''}
            <p><strong>Deficiencia estimada:</strong></p>
            <ul><li>Nitrógeno (N): ${fmt(defN)}</li><li>Fósforo (P): ${fmt(defP)}</li><li>Potasio (K): ${fmt(defK)}</li></ul>
          `;

          const fertRows = Object.values(fertilizers).map(f=>{
            const comps=[]; if(f.N) comps.push(`N: ${f.N}%`); if(f.P) comps.push(`P₂O₅: ${f.P}%`);
            if(f.K) comps.push(`K₂O: ${f.K}%`); if(f.S) comps.push(`S: ${f.S}%`); if(f.Ca) comps.push(`Ca: ${f.Ca}%`); if(f.Zn) comps.push(`Zn: ${f.Zn}%`);
            return `<tr><td>${f.name}</td><td>${comps.join(', ')}</td><td>${(f.efficiency*100).toFixed(0)}%</td></tr>`;
          }).join('');

          const fertTableHtml = `
            <h3>Eficiencia de fertilizantes principales</h3>
            <table class="fertilizer-table">
              <thead><tr><th>Fertilizante</th><th>Composición aproximada</th><th>Eficiencia</th></tr></thead>
              <tbody>${fertRows}</tbody>
            </table>`;

          const fertRecommendationHtml = `
            <h3>Recomendación de fertilizantes y dosis</h3>
            <ul>
              <li>Nitrógeno (N): ${doseN>0 ? `aplicar ${defaultFertilizerFor.N.name} – dosis aprox. ${fmt(doseN)}` : 'no se requiere'}</li>
              <li>Fósforo (P): ${doseP>0 ? `aplicar ${defaultFertilizerFor.P.name} – dosis aprox. ${fmt(doseP)}` : 'no se requiere'}</li>
              <li>Potasio (K): ${doseK>0 ? `aplicar ${defaultFertilizerFor.K.name} – dosis aprox. ${fmt(doseK)}` : 'no se requiere'}</li>
            </ul>`;

          resultContainer.innerHTML = html + fertRecommendationHtml + fertTableHtml;
          resultContainer.style.display = 'block';
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        } catch (err) {
          console.error(err);
          alert('Ocurrió un error inesperado. Recargá la página e intentá nuevamente.');
        }
      });
    </script>
  </body>
</html>
