<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NutriSeed – Calculadora de Deficiencias Nutricionales</title>
    <meta http-equiv="Cache-Control" content="no-store" />
    <style>
      :root {
        --card-bg: rgba(255, 255, 255, 0.25);
        --border-color: rgba(255, 255, 255, 0.3);
        --accent-color: #f7bf2c;
        --text-color: #3d3d3c;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
        background: linear-gradient(135deg, #3d3d3c, #f7bf2c);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .app-wrapper {
        backdrop-filter: blur(15px);
        background: var(--card-bg);
        border-radius: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        padding: 2rem;
        width: 100%;
        max-width: 600px;
        display: flex;
        flex-direction: column;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      h1 {
        margin: 0;
        color: var(--text-color);
        font-size: 2rem;
      }
      .logo-wrap { width: 80px; flex: 0 0 auto; }
      .logo-wrap svg { width: 100%; height: auto; display:block; }
      label {
        display: block;
        margin-top: 1rem;
        font-weight: 600;
        color: var(--text-color);
      }
      input, select, button {
        width: 100%;
        font-size: 1rem;
      }
      input, select {
        padding: 0.6rem 0.8rem;
        margin-top: 0.4rem;
        border-radius: 0.8rem;
        border: 1px solid var(--border-color);
        background: rgba(255, 255, 255, 0.4);
        color: #333;
      }
      button {
        padding: 0.8rem;
        margin-top: 1.5rem;
        border-radius: 1rem;
        border: none;
        background: linear-gradient(145deg, var(--accent-color), #3d3d3c);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s ease;
      }
      button:active { transform: scale(0.98); }
      .result {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 1rem;
        background: rgba(255, 255, 255, 0.3);
        color: var(--text-color);
        display: none;
        line-height: 1.6;
      }
      .fertilizer-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.9rem;
      }
      .fertilizer-table th, .fertilizer-table td {
        padding: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: left;
        color: var(--text-color);
      }
      .fertilizer-table th {
        font-weight: bold;
        background: rgba(255, 255, 255, 0.2);
      }
      .error {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: #fff3f3;
        color: #b00020;
        border: 1px solid #f5c2c7;
        border-radius: 0.8rem;
        display:none;
      }
      footer { margin-top: 2rem; text-align: center; color: var(--text-color); font-size: 0.9rem; }
      @media (max-width: 600px) {
        .app-wrapper { padding: 1.5rem; border-radius: 1.5rem; }
        h1 { font-size: 1.6rem; }
        .logo-wrap { width: 64px; }
      }
    </style>
  </head>
  <body>
    <div class="app-wrapper">
      <div class="header">
        <h1>NutriSeed</h1>
        <!-- Logo SVG inline -->
        <div class="logo-wrap" aria-label="Logo PreSeeds">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 428 525">
            <defs>
              <style>
                .cls-1{fill:#3d3d3c;}
                .cls-2{fill:#ffd727;}
                .cls-3{fill:#4a4a4a;}
                .cls-4{fill:#b3b4b4;}
                .cls-5{fill:#fff;}
              </style>
            </defs>
            <g id="Capa_2" data-name="Capa 2">
              <g id="Capa_1-2" data-name="Capa 1">
                <path class="cls-1" d="M0,378C0,305.56,57.57,259.7,125.42,268.26c64.34,8.06,109.48,62.53,109.48,130.11v115.88H0Z"/>
                <path class="cls-2" d="M428,378c0-72.44-57.61-118.3-125.46-109.74C238.17,276.32,193,330.79,193,398.37V514.25H428Z"/>
                <path class="cls-3" d="M229.47,285.73c69.51-25.49,86.86-85.44,87.72-121.87C319.44,69.9,245.09,0,151.44,0,77,.12,.16,42.83,.16,116.7c0,48.13,20.66,89.65,54.48,114.7,8.73,6.52,17.25,11.33,29.42,15.88-11.44,5.19-20.67,11.34-27.75,17.21C32.73,186,21.16,142.28,21.16,115.5,21.16,51,80.62,20.5,151.31,20.5c92.4,0,143.87,61.6,144,141.66C295.44,211.48,279.21,263.15,229.47,285.73Z"/>
                <path class="cls-3" d="M106.31,243.67C61.05,225.41,34.77,198.1,34.77,136.37c0-39.41,24-82.59,92.74-85.74-79.69,20.27-64.56,114.25-33.2,176.68Z"/>
                <path class="cls-4" d="M104.67,207.38c-31.35-62.43-46.49-156.41,33.2-176.68,67.5-2.68,111.83,29.2,136.22,78.07C284.68,122.26,287,164.76,266.36,202,239.15,250.69,179,226.3,104.67,207.38Z"/>
                <path class="cls-5" d="M248.73,91.32c16.31,31.16,21.65,64.47,14.76,92-14,56.32-109.72,23.65-153.82,10.93-8.17-12-15.12-25.73-20.21-40.64,18.52,8.11,44.6,16.88,74.69,21.91a325.24,325.24,0,0,0,74.58,3.49c-11.83-8.78-26.59-23.35-40.37-45.52,22.49,9.13,37.5,16.56,45.39,15.6C247.63,148.44,256.26,125.68,248.73,91.32Z"/>
              </g>
            </g>
          </svg>
        </div>
      </div>

      <form id="nutriForm" novalidate>
        <label for="crop">Cultivo</label>
        <select id="crop" required>
          <option value="" disabled selected>Selecciona un cultivo</option>
          <option value="soja">Soja</option>
          <option value="trigo">Trigo</option>
          <option value="maiz">Maíz</option>
          <option value="girasol">Girasol</option>
          <option value="mani">Maní</option>
          <option value="cebada">Cebada</option>
          <option value="lenteja">Lenteja</option>
          <option value="arveja">Arveja</option>
          <option value="picingallo">Maíz Picingallo</option>
          <option value="algodon">Algodón</option>
        </select>

        <label for="yearType">Condición del año</label>
        <select id="yearType" required>
          <option value="" disabled selected>Selecciona una condición</option>
          <option value="seco">Seco</option>
          <option value="neutro">Neutro</option>
          <option value="humedo">Húmedo</option>
        </select>

        <label for="nVal">Análisis Nitrógeno (N)</label>
        <input type="number" id="nVal" placeholder="Ingresa N (ppm)" step="0.01" min="0" required />

        <label for="pVal">Análisis Fósforo (P)</label>
        <input type="number" id="pVal" placeholder="Ingresa P (ppm)" step="0.01" min="0" required />

        <label for="kVal">Análisis Potasio (K)</label>
        <input type="number" id="kVal" placeholder="Ingresa K (ppm)" step="0.01" min="0" required />

        <label for="omVal">Materia orgánica (%)</label>
        <input type="number" id="omVal" placeholder="Ingresa % MO" step="0.01" min="0" />

        <label for="sVal">Azufre (S)</label>
        <input type="number" id="sVal" placeholder="Ingresa S (mg/kg)" step="0.01" min="0" />

        <label for="caVal">Calcio (Ca)</label>
        <input type="number" id="caVal" placeholder="Ingresa Ca (mg/kg)" step="0.01" min="0" />

        <label for="mgVal">Magnesio (Mg)</label>
        <input type="number" id="mgVal" placeholder="Ingresa Mg (mg/kg)" step="0.01" min="0" />

        <label for="nanVal">NAN</label>
        <input type="number" id="nanVal" placeholder="Ingresa NAN" step="0.01" min="0" />

        <label for="ecVal">Conductividad eléctrica (CE)</label>
        <input type="number" id="ecVal" placeholder="Ingresa CE (dS/m)" step="0.01" min="0" />

        <label for="cicVal">CIC (meq/100g)</label>
        <input type="number" id="cicVal" placeholder="Ingresa CIC" step="0.01" min="0" />

        <label for="psiVal">PSI</label>
        <input type="number" id="psiVal" placeholder="Ingresa PSI" step="0.01" min="0" />

        <label for="region">Zona (ubicación)</label>
        <select id="region">
          <option value="" disabled selected>Selecciona una zona</option>
          <option value="noa">Noroeste Argentino (NOA)</option>
          <option value="nea">Noreste Argentino (NEA)</option>
          <option value="nucleo_norte">Zona Núcleo Norte</option>
          <option value="litoral">Litoral</option>
          <option value="nucleo_sur">Zona Núcleo Sur</option>
          <option value="sudeste">Sudeste de Buenos Aires</option>
          <option value="tandil">Tandil (Buenos Aires)</option>
          <option value="monte_maiz">Monte Maíz (Córdoba)</option>
          <option value="otras">Otra zona</option>
        </select>

        <button type="submit">Calcular deficiencias</button>
      </form>

      <div class="error" id="errorBox"></div>
      <div id="result" class="result"></div>
      <canvas id="responseChart" width="500" height="300" style="width: 100%; max-width: 100%; margin-top: 1.5rem; display: none;"></canvas>
      <footer>&copy; 2025 NutriSeed</footer>
    </div>

    <script>
      // --- Datos y utilidades ---
      const baseRecommendations = {
        soja:{N:35,P:45,K:100}, trigo:{N:40,P:30,K:50}, maiz:{N:60,P:35,K:80},
        girasol:{N:25,P:40,K:60}, mani:{N:20,P:25,K:30}, cebada:{N:35,P:25,K:40},
        lenteja:{N:20,P:30,K:20}, arveja:{N:20,P:35,K:30}, picingallo:{N:50,P:30,K:60},
        algodon:{N:45,P:25,K:70},
      };
      const fertilizers = {
        urea:{name:'Urea',N:46,P:0,K:0,efficiency:0.60},
        uan:{name:'UAN (Urea-Ammonium Nitrate)',N:32,P:0,K:0,efficiency:0.78},
        solmix:{name:'SolMIX',N:28,P:0,K:0,S:5.2,Zn:0.5,efficiency:0.80},
        can:{name:'Nitrato de amonio calcáreo (CAN)',N:27,P:0,K:0,Ca:9,efficiency:0.70},
        tsp:{name:'Superfosfato triple (TSP)',N:0,P:46,K:0,efficiency:0.25},
        ssp:{name:'Superfosfato simple (SSP)',N:0,P:20,K:0,S:14,Ca:12,efficiency:0.20},
        map:{name:'Fosfato monoamónico (MAP)',N:11,P:52,K:0,efficiency:0.30},
        dap:{name:'Fosfato diamónico (DAP)',N:18,P:46,K:0,efficiency:0.30},
        micro:{name:'Microgranulados arrancadores',N:8,P:30,K:0,efficiency:0.35},
        an:{name:'Nitrato de amonio (AN)',N:34,P:0,K:0,efficiency:0.70},
        kcl:{name:'Cloruro de potasio (KCl)',N:0,P:0,K:60,efficiency:0.50},
      };
      const conversionFactors = { P_TO_P2O5:2.29, P2O5_TO_P:0.44, K_TO_K2O:1.20, K2O_TO_K:0.83 };
      const defaultFertilizerFor = { N:fertilizers.urea, P:fertilizers.map, K:fertilizers.kcl };
      const yearMultipliers = { seco:1.1, neutro:1.0, humedo:0.9 };
      const regionMultipliers = {
        noa:{N:1.20,P:1.10,K:1.05}, nea:{N:1.15,P:1.20,K:1.05}, nucleo_norte:{N:1.05,P:1.05,K:1.00},
        litoral:{N:1.05,P:1.10,K:1.00}, nucleo_sur:{N:0.95,P:1.00,K:1.00}, sudeste:{N:0.90,P:1.00,K:1.05},
        tandil:{N:0.95,P:1.00,K:1.00}, monte_maiz:{N:1.05,P:1.05,K:1.00}, otras:{N:1.00,P:1.00,K:1.00},
      };
      const $ = sel => document.querySelector(sel);
      const $$ = sel => document.querySelectorAll(sel);
      const formatNumber = v => Number(v).toFixed(2);
      const calculateDeficiency = (recommended, actual) => Math.max(0, recommended - actual);
      function adjustRecommendations(nRec,pRec,kRec,om,cic,psi){
        let N=nRec,P=pRec,K=kRec;
        if(!isNaN(om)){ if(om>4)N*=0.8; else if(om<2)N*=1.1; }
        if(!isNaN(cic)){ if(cic>20)K*=0.9; else if(cic<10)K*=1.1; }
        if(!isNaN(psi)){ if(psi>30)P*=0.9; else if(psi<10)P*=1.1; }
        return {N,P,K};
      }
      function generateResponseData(maxYield, baseRecN){
        const data=[]; if(!baseRecN||baseRecN<=0) return data;
        const maxX=baseRecN*2, step=maxX/20, rate=1/baseRecN;
        for(let x=0; x<=maxX+1e-6; x+=step){ const y=maxYield*(1-Math.exp(-rate*x)); data.push({x,y}); }
        return data;
      }
      function renderChart(data, recommendedN, currentN){
        const canvas=$("#responseChart"); if(!canvas||!canvas.getContext) return;
        // Ajuste retina
        const dpr = window.devicePixelRatio || 1;
        const cssW = canvas.clientWidth || 500;
        const cssH = canvas.clientHeight || 300;
        canvas.width = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);
        const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
        // Área
        const width = cssW, height = cssH;
        ctx.clearRect(0,0,width,height);
        const padding=50, left=padding, right=width-padding, bottom=height-padding, top=padding;
        const innerW=right-left, innerH=bottom-top;
        const xMax=data.length?Math.max(...data.map(d=>d.x)):1;
        const yMax=data.length?Math.max(...data.map(d=>d.y)):1;
        const xScale=innerW/xMax, yScale=innerH/yMax;
        ctx.strokeStyle='#3d3d3c'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,bottom); ctx.lineTo(right,bottom); ctx.stroke();
        // Ticks X
        const ticksX=5; ctx.fillStyle='#3d3d3c'; ctx.textAlign='center'; ctx.font='12px Arial';
        for(let i=0;i<=ticksX;i++){ const xVal=(xMax/ticksX)*i; const xPos=left+xVal*xScale;
          ctx.beginPath(); ctx.moveTo(xPos,bottom); ctx.lineTo(xPos,bottom+5); ctx.stroke();
          ctx.fillText(xVal.toFixed(0), xPos, bottom+20);
        }
        // Ticks Y
        const ticksY=5; ctx.textAlign='right';
        for(let i=0;i<=ticksY;i++){ const yVal=(yMax/ticksY)*i; const yPos=bottom-yVal*yScale;
          ctx.beginPath(); ctx.moveTo(left-5,yPos); ctx.lineTo(left,yPos); ctx.stroke();
          ctx.fillText(yVal.toFixed(0), left-10, yPos+4);
        }
        // Labels
        ctx.textAlign='center'; ctx.font='14px Arial';
        ctx.fillText('Dosis de N (unidades)', (left+right)/2, height-10);
        ctx.save(); ctx.translate(15,(top+bottom)/2); ctx.rotate(-Math.PI/2); ctx.fillText('Rendimiento relativo (%)',0,-20); ctx.restore();
        // Curva
        if(data.length>0){ ctx.strokeStyle='#f7bf2c'; ctx.lineWidth=2; ctx.beginPath();
          data.forEach((d,i)=>{ const px=left+d.x*xScale; const py=bottom-d.y*yScale; if(i===0)ctx.moveTo(px,py); else ctx.lineTo(px,py); });
          ctx.stroke();
        }
        // Líneas verticales
        if(recommendedN>0){ const xPos=left+recommendedN*xScale; ctx.strokeStyle='#3d3d3c'; ctx.setLineDash([5,5]);
          ctx.beginPath(); ctx.moveTo(xPos,top); ctx.lineTo(xPos,bottom); ctx.stroke(); ctx.setLineDash([]);
          ctx.fillStyle='#3d3d3c'; ctx.fillText('N recomendado', xPos, top-10);
        }
        if(currentN>0){ const xPos2=left+currentN*xScale; ctx.strokeStyle='#bd5f00'; ctx.setLineDash([5,5]);
          ctx.beginPath(); ctx.moveTo(xPos2,top); ctx.lineTo(xPos2,bottom); ctx.stroke(); ctx.setLineDash([]);
          ctx.fillStyle='#bd5f00'; ctx.fillText('N en suelo', xPos2, top-10);
        }
      }

      // --- Lógica principal ---
      const form = document.getElementById('nutriForm');
      const resultContainer = document.getElementById('result');
      const errorBox = document.getElementById('errorBox');

      form.addEventListener('submit', function (event) {
        event.preventDefault();
        errorBox.style.display='none'; errorBox.textContent='';
        try {
          const cropKey = document.getElementById('crop').value;
          const yearKey = document.getElementById('yearType').value;
          const nVal = parseFloat(document.getElementById('nVal').value);
          const pVal = parseFloat(document.getElementById('pVal').value);
          const kVal = parseFloat(document.getElementById('kVal').value);
          const omVal = parseFloat(document.getElementById('omVal').value);
          const sVal = parseFloat(document.getElementById('sVal').value);
          const caVal = parseFloat(document.getElementById('caVal').value);
          const mgVal = parseFloat(document.getElementById('mgVal').value);
          const nanVal = parseFloat(document.getElementById('nanVal').value);
          const ecVal = parseFloat(document.getElementById('ecVal').value);
          const cicVal = parseFloat(document.getElementById('cicVal').value);
          const psiVal = parseFloat(document.getElementById('psiVal').value);

          if (!cropKey || !yearKey || isNaN(nVal) || isNaN(pVal) || isNaN(kVal)) {
            alert('Por favor, completa todos los campos obligatorios correctamente.');
            return;
          }

          const base = baseRecommendations[cropKey];
          const multiplier = yearMultipliers[yearKey];
          const baseRecN = base.N * multiplier;
          const baseRecP = base.P * multiplier;
          const baseRecK = base.K * multiplier;

          const adjusted = adjustRecommendations(baseRecN, baseRecP, baseRecK, omVal, cicVal, psiVal);
          let adjRecN = adjusted.N, adjRecP = adjusted.P, adjRecK = adjusted.K;

          const regionKeyVal = document.getElementById('region').value;
          if (regionKeyVal && regionMultipliers[regionKeyVal]) {
            const rm = regionMultipliers[regionKeyVal];
            adjRecN *= rm.N; adjRecP *= rm.P; adjRecK *= rm.K;
          }

          const defN = calculateDeficiency(adjRecN, nVal);
          const defP = calculateDeficiency(adjRecP, pVal);
          const defK = calculateDeficiency(adjRecK, kVal);

          let extraMetricsHtml='';
          if (!isNaN(omVal)) extraMetricsHtml += `<li>Materia orgánica (MO): ${formatNumber(omVal)} %</li>`;
          if (!isNaN(cicVal)) extraMetricsHtml += `<li>CIC: ${formatNumber(cicVal)}</li>`;
          if (!isNaN(psiVal)) extraMetricsHtml += `<li>PSI: ${formatNumber(psiVal)}</li>`;
          if (!isNaN(ecVal)) extraMetricsHtml += `<li>Conductividad eléctrica (CE): ${formatNumber(ecVal)}</li>`;
          if (!isNaN(sVal)) extraMetricsHtml += `<li>Azufre (S): ${formatNumber(sVal)}</li>`;
          if (!isNaN(caVal)) extraMetricsHtml += `<li>Calcio (Ca): ${formatNumber(caVal)}</li>`;
          if (!isNaN(mgVal)) extraMetricsHtml += `<li>Magnesio (Mg): ${formatNumber(mgVal)}</li>`;
          if (!isNaN(nanVal)) extraMetricsHtml += `<li>NAN: ${formatNumber(nanVal)}</li>`;

          let resultHtml = `
            <h3>Resultados</h3>
            <p><strong>Condición del año:</strong> ${yearKey.charAt(0).toUpperCase()+yearKey.slice(1)}</p>
            <p><strong>Zona:</strong> ${(() => {
              const rk=document.getElementById('region').value;
              if (!rk) return 'No especificada';
              const opt=document.querySelector('#region option[value="'+rk+'"]');
              return opt ? opt.textContent : rk;
            })()}</p>
            <p><strong>Recomendaciones base (N-P-K):</strong> ${formatNumber(baseRecN)} - ${formatNumber(baseRecP)} - ${formatNumber(baseRecK)}</p>
            <p><strong>Recomendaciones ajustadas (N-P-K):</strong> ${formatNumber(adjRecN)} - ${formatNumber(adjRecP)} - ${formatNumber(adjRecK)}</p>
            <p><strong>Valores medidos (N-P-K):</strong> ${formatNumber(nVal)} - ${formatNumber(pVal)} - ${formatNumber(kVal)}</p>`;
          if (extraMetricsHtml) {
            resultHtml += `<p><strong>Parámetros de suelo introducidos:</strong></p><ul>${extraMetricsHtml}</ul>`;
          }
          resultHtml += `
            <p><strong>Deficiencia estimada:</strong></p>
            <ul>
              <li>Nitrógeno (N): ${formatNumber(defN)}</li>
              <li>Fósforo (P): ${formatNumber(defP)}</li>
              <li>Potasio (K): ${formatNumber(defK)}</li>
            </ul>
            <p>Una deficiencia de 0 significa que el suelo contiene al menos la cantidad recomendada de ese nutriente.</p>
          `;

          function computeDose(def, nutrientKey){
            if(!def || def<=0) return 0;
            const fert = defaultFertilizerFor[nutrientKey]; if(!fert) return 0;
            let required = def;
            if(nutrientKey==='P') required = def * conversionFactors.P_TO_P2O5;
            else if(nutrientKey==='K') required = def * conversionFactors.K_TO_K2O;
            const contentPerc = (nutrientKey==='N')?fert.N:(nutrientKey==='P')?fert.P:fert.K;
            const contentFraction = contentPerc/100; if(!contentFraction) return 0;
            const eff = fert.efficiency || 1;
            return required / (contentFraction * eff);
          }
          const doseN = computeDose(defN, 'N');
          const doseP = computeDose(defP, 'P');
          const doseK = computeDose(defK, 'K');

          const fertRecommendationHtml = `
            <h3>Recomendación de fertilizantes y dosis</h3>
            <ul>
              <li>Nitrógeno (N): ${doseN>0 ? `aplicar ${defaultFertilizerFor.N.name} – ${formatNumber(doseN)}` : 'no se requiere fertilizante N'}</li>
              <li>Fósforo (P): ${doseP>0 ? `aplicar ${defaultFertilizerFor.P.name} – ${formatNumber(doseP)}` : 'no se requiere fertilizante P'}</li>
              <li>Potasio (K): ${doseK>0 ? `aplicar ${defaultFertilizerFor.K.name} – ${formatNumber(doseK)}` : 'no se requiere fertilizante K'}</li>
            </ul>
          `;

          resultContainer.innerHTML = resultHtml + fertRecommendationHtml + buildFertsTable();
          resultContainer.style.display = 'block';

          const chartData = generateResponseData(100, adjRecN);
          const canvasEl = document.getElementById('responseChart');
          if (canvasEl) canvasEl.style.display = 'block';
          renderChart(chartData, adjRecN, nVal);
        } catch (err) {
          console.error(err);
          errorBox.textContent = 'Ocurrió un error inesperado al calcular. Detalle: ' + err.message;
          errorBox.style.display = 'block';
        }
      });

      function buildFertsTable(){
        let rows='';
        for (const key in fertilizers){
          const f=fertilizers[key];
          const comps=[];
          if(f.N>0) comps.push(`N: ${f.N}%`);
          if(f.P>0) comps.push(`P₂O₅: ${f.P}%`);
          if(f.K>0) comps.push(`K₂O: ${f.K}%`);
          if(f.S>0) comps.push(`S: ${f.S}%`);
          if(f.Ca>0) comps.push(`Ca: ${f.Ca}%`);
          if(f.Zn>0) comps.push(`Zn: ${f.Zn}%`);
          const compStr = comps.join(', ');
          const effPercent = ((f.efficiency||0)*100).toFixed(0) + '%';
          rows += `<tr><td>${f.name}</td><td>${compStr}</td><td>${effPercent}</td></tr>`;
        }
        return `
          <h3>Eficiencia de fertilizantes principales</h3>
          <table class="fertilizer-table">
            <thead><tr><th>Fertilizante</th><th>Composición aproximada</th><th>Eficiencia</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }
    </script>
  </body>
</html>
